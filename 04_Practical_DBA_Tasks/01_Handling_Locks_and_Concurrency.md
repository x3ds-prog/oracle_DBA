# Модуль 4: Практические задачи администратора

## Урок 1: Диагностика блокировок и управление параллелизмом

Поздравляю! Вы дошли до модуля, где мы будем решать проблемы, с которыми сталкиваются настоящие администраторы баз данных. И первая такая проблема — **блокировки**.

### Сценарий: Ошибка `ORA-00054: resource busy`

Представим ситуацию: вы пытаетесь создать индекс, как мы делали в прошлом уроке, но внезапно получаете ошибку:
`ORA-00054: resource busy and acquire with NOWAIT specified or timeout expired`

Что это значит?

> **Для админа Linux: Аналогии**
>
> Ошибка `ORA-00054` — это почти точный эквивалент ошибки `umount: /mnt/data: target is busy.` в Linux.
> Она означает, что вы пытаетесь выполнить **эксклюзивную** операцию (как `umount`) над ресурсом (таблицей), который в данный момент кем-то используется (открыт файл, идет запись).

В мире Oracle это означает, что кто-то (скорее всего, вы сами в другой сессии) держит **транзакционную блокировку** на таблице, структуру которой вы пытаетесь изменить.

### DML vs. DDL: Типы операций и блокировок

Чтобы понять причину, нужно знать о двух типах SQL операций:

1.  **DML (Data Manipulation Language):** Это команды для работы с *данными* — `INSERT`, `UPDATE`, `DELETE`.
    -   Когда вы выполняете DML, Oracle ставит на измененные строки **разделяемую (shared)** блокировку. Это "мягкая" блокировка. Другие сессии могут по-прежнему читать эти данные (старую версию, до `COMMIT`), но не могут их изменять.

2.  **DDL (Data Definition Language):** Это команды для работы со *структурой* — `CREATE TABLE`, `ALTER TABLE`, `CREATE INDEX`.
    -   Когда вы выполняете DDL, Oracle пытается поставить **эксклюзивную (exclusive)** блокировку на всю таблицу. Это "жесткая" блокировка. Она требует, чтобы с таблицей больше **никто** не работал.

**Причина ошибки `ORA-00054`:**
1.  **Сессия А** выполнила `INSERT` в таблицу `employees`, но **не сделала `COMMIT`**. На таблице "висит" мягкая DML блокировка.
2.  **Сессия Б** пытается выполнить `CREATE INDEX` на таблице `employees`. Эта DDL-операция требует жесткой блокировки.
3.  DDL-операции в Oracle не ждут в очереди. Они видят, что ресурс занят, и немедленно падают с ошибкой `resource busy`.

### Диагностика: Кто держит блокировку?

Как и в Linux, в Oracle есть инструменты, чтобы посмотреть, кто "держит" ресурс. Вместо `/proc` и `lsof` мы будем использовать **системные представления (Data Dictionary Views)**.

Чтобы найти блокирующую сессию, мы можем "сджойнить" два представления:
-   `v$session`: Аналог `ps -aux`. Список всех активных сессий (процессов).
-   `v$locked_object`: Аналог `lsof`. Список заблокированных объектов и сессий, которые их держат.

Вот диагностический запрос, который должен быть в "шпаргалке" у каждого DBA:

```sql
SELECT
    s.sid,
    s.serial#,
    s.username,
    s.program,
    o.object_name
FROM
    v$locked_object l
JOIN
    dba_objects o ON l.object_id = o.object_id
JOIN
    v$session s ON l.session_id = s.sid
WHERE
    o.object_name = 'EMPLOYEES'; -- Указываем имя нашей таблицы в верхнем регистре
```
Этот запрос покажет вам `SID` и `SERIAL#` (уникальные идентификаторы сессии), имя пользователя и программу, которая держит блокировку на таблице `EMPLOYEES`.

### Решение проблемы

Есть два пути: "хороший" и "радикальный".

**1. "Хороший" путь: Завершить транзакцию**

Самый правильный способ — найти сессию-виновника (которую вы нашли на шаге диагностики) и завершить в ней транзакцию.
-   Если это ваша сессия в другом окне, просто переключитесь в нее и выполните `COMMIT` или `ROLLBACK`.
-   `COMMIT` сохранит изменения и снимет блокировку.
-   `ROLLBACK` отменит изменения и снимет блокировку.

Как только транзакция будет завершена, вы сможете успешно выполнить свою DDL-команду (`CREATE INDEX`).

**2. "Радикальный" путь: `kill -9`**

Если вы не можете получить доступ к сессии-виновнику (например, это чужой оборванный коннект), вы, как администратор, можете принудительно ее завершить.

Для этого используется команда `ALTER SYSTEM KILL SESSION`. Вам понадобятся `SID` и `SERIAL#` из диагностического запроса.

```sql
-- Пример:
ALTER SYSTEM KILL SESSION '145,54321';
```
*Замените `145,54321` на реальные значения `SID,SERIAL#`.*

Эта команда "убивает" сессию на стороне сервера. Ее транзакция автоматически откатывается (`ROLLBACK`), и все блокировки снимаются. Используйте этот способ с осторожностью.

### Что дальше?
Вы научились диагностировать и решать одну из самых частых проблем администратора. Теперь вы готовы к финальному уроку этого курса, где мы снова вернемся к `EXPLAIN PLAN` и обсудим его более подробно.
